import avidaspatial.environment_generator as eg
from avidaspatial import *
from collections import Counter


def test_gen_reaction():
    args = eg.get_args()
    args.maxCount = 20
    rxn = gen_reaction(args, "resAND", 1)
    assert(rxn ==
           "REACTION AND and process:resource=resAND:value=2.0:type=pow:" +
           "frac=0.0025:max=25:depletable=1 requisite:max_count=20\n")


def test_gen_res():
    args = eg.get_args()
    res = gen_res(args, "resAND", 100, .1)
    assert(res == "RESOURCE resAND:inflow=100:outflow=0.1\n")


def test_gen_cell():
    args = eg.get_args()
    args.cellInflow = 10
    args.cellOutflow = 1
    args.inflow = 100
    res = gen_cell(args, "resAND", [1, 4, 5, 6, 9, 10])
    assert(res == "CELL resAND:1,4,5,6,9,10:inflow=10:outflow=1:initial=100\n")


def test_gen_gradient():
    args = eg.get_args()
    res = gen_gradient(args, "resAND", 100, 5, (4, 5))
    assert (res == "GRADIENT_RESOURCE resAND:height=5:plateau=100:" +
            "spread=4:common=1:updatestep=1000000:peakx=4:peaky=5:" +
            "plateau_inflow=100:initial=100\n")


def test_calcEvenAnchors():
    args = eg.get_args()
    anchors = calcEvenAnchors(args)
    assert(len(anchors) == args.patchesPerSide**2)
    numbers = set()
    for pair in anchors:
        numbers.add(pair[0])
        numbers.add(pair[1])
    assert(len(numbers) == args.patchesPerSide)
    numbers = list(numbers)
    numbers.sort()
    diffs = [numbers[0]]
    for i in range(len(numbers)-2):
        diffs.append(numbers[i+1]-numbers[i])
    diffs.append(args.worldSize - numbers[-1])
    avg_diff = sum(diffs)/len(diffs)
    for diff in diffs:
        assert(abs(diff - avg_diff) < args.patchesPerSide)


def test_calcRandomAnchors():
    args = eg.get_args()
    anchors = calcRandomAnchors(args)
    assert(len(anchors) == args.nPatches)


def test_genRandResources():
    args = eg.get_args()
    test_resources = ["1", "2", "3", "4"]
    rand_resources = genRandResources(args, test_resources)
    assert(len(rand_resources) == args.nPatches)
    c = Counter(rand_resources)
    assert(max(c.values()) - min(c.values()) <= 1)


def test_random_patch():
    args = eg.get_args()
    patch = random_patch(args, 50)
    assert(len(patch) == 50)


# TODO: Make this test better
def test_calcTightAnchors():
    args = eg.get_args()
    odd_anchors = calcTightAnchors(args, 5, args.patchesPerSide**2)
    even_anchors = calcTightAnchors(args, 6, args.patchesPerSide**2)


def test_place_even_squares():
    args = eg.get_args()
    cells = place_even_squares(args, 5)
    assert(cells == [0,
                     1,
                     2,
                     3,
                     4,
                     10,
                     11,
                     12,
                     13,
                     14,
                     20,
                     21,
                     22,
                     23,
                     24,
                     30,
                     31,
                     32,
                     33,
                     34,
                     40,
                     41,
                     42,
                     43,
                     44,
                     50,
                     51,
                     52,
                     53,
                     54,
                     60,
                     61,
                     62,
                     63,
                     64,
                     70,
                     71,
                     72,
                     73,
                     74,
                     80,
                     81,
                     82,
                     83,
                     84,
                     90,
                     91,
                     92,
                     93,
                     94,
                     100,
                     101,
                     102,
                     103,
                     104,
                     110,
                     111,
                     112,
                     113,
                     114,
                     120,
                     121,
                     122,
                     123,
                     124,
                     130,
                     131,
                     132,
                     133,
                     134,
                     140,
                     141,
                     142,
                     143,
                     144,
                     150,
                     151,
                     152,
                     153,
                     154,
                     160,
                     161,
                     162,
                     163,
                     164,
                     170,
                     171,
                     172,
                     173,
                     174,
                     180,
                     181,
                     182,
                     183,
                     184,
                     190,
                     191,
                     192,
                     193,
                     194,
                     200,
                     201,
                     202,
                     203,
                     204,
                     210,
                     211,
                     212,
                     213,
                     214,
                     220,
                     221,
                     222,
                     223,
                     224,
                     230,
                     231,
                     232,
                     233,
                     234,
                     240,
                     241,
                     242,
                     243,
                     244,
                     250,
                     251,
                     252,
                     253,
                     254,
                     260,
                     261,
                     262,
                     263,
                     264,
                     270,
                     271,
                     272,
                     273,
                     274,
                     280,
                     281,
                     282,
                     283,
                     284,
                     290,
                     291,
                     292,
                     293,
                     294,
                     600,
                     601,
                     602,
                     603,
                     604,
                     610,
                     611,
                     612,
                     613,
                     614,
                     620,
                     621,
                     622,
                     623,
                     624,
                     630,
                     631,
                     632,
                     633,
                     634,
                     640,
                     641,
                     642,
                     643,
                     644,
                     650,
                     651,
                     652,
                     653,
                     654,
                     660,
                     661,
                     662,
                     663,
                     664,
                     670,
                     671,
                     672,
                     673,
                     674,
                     680,
                     681,
                     682,
                     683,
                     684,
                     690,
                     691,
                     692,
                     693,
                     694,
                     700,
                     701,
                     702,
                     703,
                     704,
                     710,
                     711,
                     712,
                     713,
                     714,
                     720,
                     721,
                     722,
                     723,
                     724,
                     730,
                     731,
                     732,
                     733,
                     734,
                     740,
                     741,
                     742,
                     743,
                     744,
                     750,
                     751,
                     752,
                     753,
                     754,
                     760,
                     761,
                     762,
                     763,
                     764,
                     770,
                     771,
                     772,
                     773,
                     774,
                     780,
                     781,
                     782,
                     783,
                     784,
                     790,
                     791,
                     792,
                     793,
                     794,
                     800,
                     801,
                     802,
                     803,
                     804,
                     810,
                     811,
                     812,
                     813,
                     814,
                     820,
                     821,
                     822,
                     823,
                     824,
                     830,
                     831,
                     832,
                     833,
                     834,
                     840,
                     841,
                     842,
                     843,
                     844,
                     850,
                     851,
                     852,
                     853,
                     854,
                     860,
                     861,
                     862,
                     863,
                     864,
                     870,
                     871,
                     872,
                     873,
                     874,
                     880,
                     881,
                     882,
                     883,
                     884,
                     890,
                     891,
                     892,
                     893,
                     894,
                     1200,
                     1201,
                     1202,
                     1203,
                     1204,
                     1210,
                     1211,
                     1212,
                     1213,
                     1214,
                     1220,
                     1221,
                     1222,
                     1223,
                     1224,
                     1230,
                     1231,
                     1232,
                     1233,
                     1234,
                     1240,
                     1241,
                     1242,
                     1243,
                     1244,
                     1250,
                     1251,
                     1252,
                     1253,
                     1254,
                     1260,
                     1261,
                     1262,
                     1263,
                     1264,
                     1270,
                     1271,
                     1272,
                     1273,
                     1274,
                     1280,
                     1281,
                     1282,
                     1283,
                     1284,
                     1290,
                     1291,
                     1292,
                     1293,
                     1294,
                     1300,
                     1301,
                     1302,
                     1303,
                     1304,
                     1310,
                     1311,
                     1312,
                     1313,
                     1314,
                     1320,
                     1321,
                     1322,
                     1323,
                     1324,
                     1330,
                     1331,
                     1332,
                     1333,
                     1334,
                     1340,
                     1341,
                     1342,
                     1343,
                     1344,
                     1350,
                     1351,
                     1352,
                     1353,
                     1354,
                     1360,
                     1361,
                     1362,
                     1363,
                     1364,
                     1370,
                     1371,
                     1372,
                     1373,
                     1374,
                     1380,
                     1381,
                     1382,
                     1383,
                     1384,
                     1390,
                     1391,
                     1392,
                     1393,
                     1394,
                     1400,
                     1401,
                     1402,
                     1403,
                     1404,
                     1410,
                     1411,
                     1412,
                     1413,
                     1414,
                     1420,
                     1421,
                     1422,
                     1423,
                     1424,
                     1430,
                     1431,
                     1432,
                     1433,
                     1434,
                     1440,
                     1441,
                     1442,
                     1443,
                     1444,
                     1450,
                     1451,
                     1452,
                     1453,
                     1454,
                     1460,
                     1461,
                     1462,
                     1463,
                     1464,
                     1470,
                     1471,
                     1472,
                     1473,
                     1474,
                     1480,
                     1481,
                     1482,
                     1483,
                     1484,
                     1490,
                     1491,
                     1492,
                     1493,
                     1494,
                     1800,
                     1801,
                     1802,
                     1803,
                     1804,
                     1810,
                     1811,
                     1812,
                     1813,
                     1814,
                     1820,
                     1821,
                     1822,
                     1823,
                     1824,
                     1830,
                     1831,
                     1832,
                     1833,
                     1834,
                     1840,
                     1841,
                     1842,
                     1843,
                     1844,
                     1850,
                     1851,
                     1852,
                     1853,
                     1854,
                     1860,
                     1861,
                     1862,
                     1863,
                     1864,
                     1870,
                     1871,
                     1872,
                     1873,
                     1874,
                     1880,
                     1881,
                     1882,
                     1883,
                     1884,
                     1890,
                     1891,
                     1892,
                     1893,
                     1894,
                     1900,
                     1901,
                     1902,
                     1903,
                     1904,
                     1910,
                     1911,
                     1912,
                     1913,
                     1914,
                     1920,
                     1921,
                     1922,
                     1923,
                     1924,
                     1930,
                     1931,
                     1932,
                     1933,
                     1934,
                     1940,
                     1941,
                     1942,
                     1943,
                     1944,
                     1950,
                     1951,
                     1952,
                     1953,
                     1954,
                     1960,
                     1961,
                     1962,
                     1963,
                     1964,
                     1970,
                     1971,
                     1972,
                     1973,
                     1974,
                     1980,
                     1981,
                     1982,
                     1983,
                     1984,
                     1990,
                     1991,
                     1992,
                     1993,
                     1994,
                     2000,
                     2001,
                     2002,
                     2003,
                     2004,
                     2010,
                     2011,
                     2012,
                     2013,
                     2014,
                     2020,
                     2021,
                     2022,
                     2023,
                     2024,
                     2030,
                     2031,
                     2032,
                     2033,
                     2034,
                     2040,
                     2041,
                     2042,
                     2043,
                     2044,
                     2050,
                     2051,
                     2052,
                     2053,
                     2054,
                     2060,
                     2061,
                     2062,
                     2063,
                     2064,
                     2070,
                     2071,
                     2072,
                     2073,
                     2074,
                     2080,
                     2081,
                     2082,
                     2083,
                     2084,
                     2090,
                     2091,
                     2092,
                     2093,
                     2094,
                     2400,
                     2401,
                     2402,
                     2403,
                     2404,
                     2410,
                     2411,
                     2412,
                     2413,
                     2414,
                     2420,
                     2421,
                     2422,
                     2423,
                     2424,
                     2430,
                     2431,
                     2432,
                     2433,
                     2434,
                     2440,
                     2441,
                     2442,
                     2443,
                     2444,
                     2450,
                     2451,
                     2452,
                     2453,
                     2454,
                     2460,
                     2461,
                     2462,
                     2463,
                     2464,
                     2470,
                     2471,
                     2472,
                     2473,
                     2474,
                     2480,
                     2481,
                     2482,
                     2483,
                     2484,
                     2490,
                     2491,
                     2492,
                     2493,
                     2494,
                     2500,
                     2501,
                     2502,
                     2503,
                     2504,
                     2510,
                     2511,
                     2512,
                     2513,
                     2514,
                     2520,
                     2521,
                     2522,
                     2523,
                     2524,
                     2530,
                     2531,
                     2532,
                     2533,
                     2534,
                     2540,
                     2541,
                     2542,
                     2543,
                     2544,
                     2550,
                     2551,
                     2552,
                     2553,
                     2554,
                     2560,
                     2561,
                     2562,
                     2563,
                     2564,
                     2570,
                     2571,
                     2572,
                     2573,
                     2574,
                     2580,
                     2581,
                     2582,
                     2583,
                     2584,
                     2590,
                     2591,
                     2592,
                     2593,
                     2594,
                     2600,
                     2601,
                     2602,
                     2603,
                     2604,
                     2610,
                     2611,
                     2612,
                     2613,
                     2614,
                     2620,
                     2621,
                     2622,
                     2623,
                     2624,
                     2630,
                     2631,
                     2632,
                     2633,
                     2634,
                     2640,
                     2641,
                     2642,
                     2643,
                     2644,
                     2650,
                     2651,
                     2652,
                     2653,
                     2654,
                     2660,
                     2661,
                     2662,
                     2663,
                     2664,
                     2670,
                     2671,
                     2672,
                     2673,
                     2674,
                     2680,
                     2681,
                     2682,
                     2683,
                     2684,
                     2690,
                     2691,
                     2692,
                     2693,
                     2694,
                     3000,
                     3001,
                     3002,
                     3003,
                     3004,
                     3010,
                     3011,
                     3012,
                     3013,
                     3014,
                     3020,
                     3021,
                     3022,
                     3023,
                     3024,
                     3030,
                     3031,
                     3032,
                     3033,
                     3034,
                     3040,
                     3041,
                     3042,
                     3043,
                     3044,
                     3050,
                     3051,
                     3052,
                     3053,
                     3054,
                     3060,
                     3061,
                     3062,
                     3063,
                     3064,
                     3070,
                     3071,
                     3072,
                     3073,
                     3074,
                     3080,
                     3081,
                     3082,
                     3083,
                     3084,
                     3090,
                     3091,
                     3092,
                     3093,
                     3094,
                     3100,
                     3101,
                     3102,
                     3103,
                     3104,
                     3110,
                     3111,
                     3112,
                     3113,
                     3114,
                     3120,
                     3121,
                     3122,
                     3123,
                     3124,
                     3130,
                     3131,
                     3132,
                     3133,
                     3134,
                     3140,
                     3141,
                     3142,
                     3143,
                     3144,
                     3150,
                     3151,
                     3152,
                     3153,
                     3154,
                     3160,
                     3161,
                     3162,
                     3163,
                     3164,
                     3170,
                     3171,
                     3172,
                     3173,
                     3174,
                     3180,
                     3181,
                     3182,
                     3183,
                     3184,
                     3190,
                     3191,
                     3192,
                     3193,
                     3194,
                     3200,
                     3201,
                     3202,
                     3203,
                     3204,
                     3210,
                     3211,
                     3212,
                     3213,
                     3214,
                     3220,
                     3221,
                     3222,
                     3223,
                     3224,
                     3230,
                     3231,
                     3232,
                     3233,
                     3234,
                     3240,
                     3241,
                     3242,
                     3243,
                     3244,
                     3250,
                     3251,
                     3252,
                     3253,
                     3254,
                     3260,
                     3261,
                     3262,
                     3263,
                     3264,
                     3270,
                     3271,
                     3272,
                     3273,
                     3274,
                     3280,
                     3281,
                     3282,
                     3283,
                     3284,
                     3290,
                     3291,
                     3292,
                     3293,
                     3294])


if __name__ == "__main__":
    test_gen_reaction()
